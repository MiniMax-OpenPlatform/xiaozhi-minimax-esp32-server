# 日志查看指南

## 快速参考

### 最常用命令

| 用途 | 命令 |
|------|------|
| 查看Web服务日志 | `sudo docker logs xiaozhi-esp32-server-web --tail 50` |
| 实时监控Web服务 | `sudo docker logs -f xiaozhi-esp32-server-web` |
| 查看Python服务日志 | `sudo docker logs xiaozhi-esp32-server --tail 50` |
| 查看错误日志 | `sudo docker logs xiaozhi-esp32-server-web 2>&1 \| grep -i error` |
| 查看容器状态 | `sudo docker ps --filter name=xiaozhi` |

---

## 1. 容器状态查看

### 查看所有运行中的容器
```bash
sudo docker ps --filter name=xiaozhi
```

### 查看所有容器（包括停止的）
```bash
sudo docker ps -a --filter name=xiaozhi
```

### 查看容器资源使用情况
```bash
sudo docker stats xiaozhi-esp32-server-web xiaozhi-esp32-server
```

---

## 2. Web服务日志（manager-api + manager-web）

容器名：`xiaozhi-esp32-server-web`  
端口：8002

### 基本查看
```bash
# 查看最后50行日志
sudo docker logs xiaozhi-esp32-server-web --tail 50

# 查看最后100行日志
sudo docker logs xiaozhi-esp32-server-web --tail 100

# 实时查看日志（按Ctrl+C退出）
sudo docker logs -f xiaozhi-esp32-server-web
```

### 时间过滤
```bash
# 查看最近1小时的日志
sudo docker logs xiaozhi-esp32-server-web --since 1h

# 查看最近30分钟的日志
sudo docker logs xiaozhi-esp32-server-web --since 30m

# 查看指定时间之后的日志
sudo docker logs xiaozhi-esp32-server-web --since "2025-10-25T00:00:00"

# 查看带时间戳的日志
sudo docker logs -t xiaozhi-esp32-server-web --tail 100
```

### 关键字过滤
```bash
# 只看错误日志
sudo docker logs xiaozhi-esp32-server-web 2>&1 | grep -i "error\|exception\|fail"

# 查看用户注册相关日志
sudo docker logs xiaozhi-esp32-server-web 2>&1 | grep -i "register\|initUserModelConfigs"

# 查看API请求日志
sudo docker logs xiaozhi-esp32-server-web 2>&1 | grep -i "POST\|GET\|PUT\|DELETE"

# 查看数据库相关日志
sudo docker logs xiaozhi-esp32-server-web 2>&1 | grep -i "sql\|jdbc"
```

---

## 3. Python服务日志（xiaozhi-server）

容器名：`xiaozhi-esp32-server`  
端口：8000, 8003

### 基本查看
```bash
# 查看最后100行日志
sudo docker logs xiaozhi-esp32-server --tail 100

# 实时查看日志
sudo docker logs -f xiaozhi-esp32-server
```

### 关键字过滤
```bash
# 查看错误信息
sudo docker logs xiaozhi-esp32-server 2>&1 | grep -i error

# 查看ASR相关日志
sudo docker logs xiaozhi-esp32-server 2>&1 | grep -i "asr\|speech"

# 查看LLM相关日志
sudo docker logs xiaozhi-esp32-server 2>&1 | grep -i "llm\|minimax"

# 查看TTS相关日志
sudo docker logs xiaozhi-esp32-server 2>&1 | grep -i "tts\|audio"

# 查看WebSocket连接日志
sudo docker logs xiaozhi-esp32-server 2>&1 | grep -i "websocket\|connected"
```

---

## 4. MySQL数据库日志

容器名：`xiaozhi-esp32-server-db`

### 查看日志
```bash
# 查看最后50行日志
sudo docker logs xiaozhi-esp32-server-db --tail 50

# 查看错误日志
sudo docker logs xiaozhi-esp32-server-db 2>&1 | grep -i error

# 实时查看日志
sudo docker logs -f xiaozhi-esp32-server-db
```

### 查看慢查询日志
```bash
sudo docker exec xiaozhi-esp32-server-db mysql -uroot -p123456 -e "SHOW VARIABLES LIKE 'slow_query_log%';"
```

---

## 5. Redis日志

容器名：`xiaozhi-esp32-server-redis`

### 查看日志
```bash
# 查看最后50行日志
sudo docker logs xiaozhi-esp32-server-redis --tail 50

# 实时查看日志
sudo docker logs -f xiaozhi-esp32-server-redis
```

---

## 6. 高级日志操作

### 日志导出
```bash
# 导出到文件
sudo docker logs xiaozhi-esp32-server-web > /tmp/web.log
sudo docker logs xiaozhi-esp32-server > /tmp/python.log

# 导出带时间戳的日志
sudo docker logs -t xiaozhi-esp32-server-web > /tmp/web_$(date +%Y%m%d_%H%M%S).log
```

### 实时监控并搜索
```bash
# 实时监控并高亮显示关键字（需要安装grep）
sudo docker logs -f xiaozhi-esp32-server-web | grep --color=auto -i "error\|warn\|info"

# 实时监控并只显示错误
sudo docker logs -f xiaozhi-esp32-server-web 2>&1 | grep -i error

# 实时监控并统计
sudo docker logs -f xiaozhi-esp32-server-web 2>&1 | grep -c "ERROR"
```

### 多容器同时查看
```bash
# 使用docker-compose查看所有日志
cd /home/moshu/xiaozhi-esp32-server/main/xiaozhi-server
sudo docker compose -f docker-compose_all.yml logs -f

# 只查看特定服务
sudo docker compose -f docker-compose_all.yml logs -f xiaozhi-esp32-server-web
```

---

## 7. 进入容器查看内部日志

### 进入Web容器
```bash
sudo docker exec -it xiaozhi-esp32-server-web bash

# 在容器内查看
ls /var/log/
ls /app/logs/  # 如果应用配置了文件日志
```

### 进入Python容器
```bash
sudo docker exec -it xiaozhi-esp32-server bash

# 在容器内查看
ls /opt/xiaozhi-esp32-server/logs/
cat /opt/xiaozhi-esp32-server/logs/app.log  # 如果有
```

---

## 8. 常见问题诊断

### 问题1：用户注册失败
```bash
# 查看用户注册相关日志
sudo docker logs xiaozhi-esp32-server-web 2>&1 | grep -i "register\|save.*user\|initUserModelConfigs"
```

### 问题2：配置信息未清空
```bash
# 查看用户初始化日志
sudo docker logs xiaozhi-esp32-server-web 2>&1 | grep -i "清空敏感字段\|clearSensitiveFields"
```

### 问题3：API调用失败
```bash
# 查看API错误日志
sudo docker logs xiaozhi-esp32-server-web 2>&1 | grep -i "exception\|error" | tail -20
```

### 问题4：数据库连接问题
```bash
# 查看数据库连接日志
sudo docker logs xiaozhi-esp32-server-web 2>&1 | grep -i "jdbc\|datasource\|connection"
```

### 问题5：WebSocket连接问题
```bash
# 查看WebSocket日志
sudo docker logs xiaozhi-esp32-server 2>&1 | grep -i "websocket\|ws://"
```

---

## 9. 日志级别说明

### Web服务（Spring Boot）
- `INFO` - 正常信息
- `DEBUG` - 调试信息（SQL查询等）
- `WARN` - 警告信息
- `ERROR` - 错误信息

### Python服务
- `INFO` - 正常信息
- `WARNING` - 警告信息
- `ERROR` - 错误信息
- `DEBUG` - 调试信息

---

## 10. 日志清理

### 注意事项
⚠️ Docker日志会持续增长，建议定期清理

### 清理方法
```bash
# 清理单个容器的日志
sudo truncate -s 0 $(sudo docker inspect --format='{{.LogPath}}' xiaozhi-esp32-server-web)

# 清理所有停止的容器
sudo docker container prune

# 配置日志大小限制（在docker-compose.yml中）
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

---

## 11. 常用日志组合命令

### 查看最近的错误并统计
```bash
sudo docker logs xiaozhi-esp32-server-web --since 1h 2>&1 | grep -i error | wc -l
```

### 查看特定时间段的API调用
```bash
sudo docker logs xiaozhi-esp32-server-web --since "2025-10-25T10:00:00" --until "2025-10-25T11:00:00" 2>&1 | grep -i "POST /models"
```

### 实时监控错误并发送通知
```bash
sudo docker logs -f xiaozhi-esp32-server-web 2>&1 | grep -i error | while read line; do echo "[ERROR] $line"; done
```

---

## 12. 日志分析工具（可选）

如果需要更强大的日志分析功能，可以考虑：

1. **Portainer** - Docker容器管理界面
   ```bash
   docker run -d -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock portainer/portainer-ce
   ```

2. **Dozzle** - 实时日志查看器
   ```bash
   docker run -d -p 8888:8080 -v /var/run/docker.sock:/var/run/docker.sock amir20/dozzle
   ```

3. **Grafana Loki** - 日志聚合系统（适合生产环境）

---

## 总结

**最常用的5个命令：**

1. `sudo docker logs xiaozhi-esp32-server-web --tail 50` - 查看Web服务日志
2. `sudo docker logs -f xiaozhi-esp32-server-web` - 实时监控Web服务
3. `sudo docker logs xiaozhi-esp32-server --tail 100` - 查看Python服务日志
4. `sudo docker logs xiaozhi-esp32-server-web 2>&1 | grep -i error` - 查看错误日志
5. `sudo docker ps --filter name=xiaozhi` - 查看容器状态

**快速排查问题的步骤：**

1. 先看容器是否正常运行：`sudo docker ps`
2. 查看最新日志：`sudo docker logs <容器名> --tail 50`
3. 搜索错误信息：`sudo docker logs <容器名> 2>&1 | grep -i error`
4. 根据错误信息定位问题
5. 如需实时监控：`sudo docker logs -f <容器名>`

